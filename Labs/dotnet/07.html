<h1 id="module-7-storing-and-consuming-files-from-azure-storage">Module 7: Storing and Consuming Files from Azure Storage</h1>
<h1 id="lab-storing-generated-documents-in-azure-storage-blobs">Lab: Storing Generated Documents in Azure Storage Blobs</h1>
<h3 id="scenario">Scenario</h3>
<p>You need a place to store the Word documents that are generated by the Contoso Events application. You decide store the generated Word documents in blobs. You also decide to create a protected container so that the Word documents are not accessed by anonymous users. Finally, you want to create the logic to generate SAS tokens for temporary access to one of the Word documents.</p>
<h3 id="objectives">Objectives</h3>
<p>After you complete this lab, you will be able to:</p>
<ul>
<li><p>Create a container by using the Azure Portal.</p>
</li>
<li><p>Add blobs to the container by using the Azure Storage SDK.</p>
</li>
<li><p>Download blobs from the container by using <strong>MemoryStream</strong> objects.</p>
</li>
<li><p>Generate SAS tokens for accessing a blob.</p>
</li>
</ul>
<h3 id="lab-setup">Lab Setup</h3>
<p><strong>Estimated Time: 60 minutes</strong></p>
<p>Before starting this lab, you must complete the lab in Module 2. For the lab in this module, you will use the available host machine. Also, you must complete the following steps:</p>
<ol>
<li><p>On the host computer, click <strong>Start</strong>, type <strong>Remote</strong>, and then click <strong>Remote Desktop Connection</strong>.</p>
</li>
<li><p>In Remote Desktop Connection, provide the name of your virtual machine in the <strong>Computer</strong> box by using the following format:</p>
<ul>
<li><strong>[Your VM IP Address]:[<em>Your VM RDP Port</em>]</strong></li>
</ul>
<blockquote>
<p><strong>Note:</strong> The name and port for your virtual machine might be saved in the Computer drop-down list. If this is the case, use this value instead of typing it in manually. If you are unsure about your virtual machine’s RDP port, use either of the Azure portals to find your virtual machine’s endpoints. The endpoint with the name <strong>Remote Desktop</strong> is the correct port for RDP. This port is randomized to protect your virtual machine from unauthorized access.</p>
</blockquote>
</li>
<li><p>In Remote Desktop Connection, click <strong>Connect</strong>. Wait until the RDP client accesses the virtual machine.</p>
</li>
<li><p>If necessary, sign in by using the following credentials:</p>
<ul>
<li><p>User name: <strong>Student</strong></p>
</li>
<li><p>Password: <strong>AzurePa$$w0rd</strong></p>
</li>
</ul>
</li>
<li><p>Verify that you received the credentials to sign in to the Azure portal from your training provider. You will use these credentials and the Azure account throughout the labs in this course.</p>
</li>
</ol>
<h2 id="exercise-1-implementing-azure-storage-blobs">Exercise 1: Implementing Azure Storage Blobs</h2>
<h3 id="scenario">Scenario</h3>
<p>In this exercise, you will:</p>
<ul>
<li><p>Create a blob container by using the Portal.</p>
</li>
<li><p>Add blob files to the container.</p>
</li>
<li><p>Access the blob files in the container.</p>
</li>
</ul>
<p>The main tasks for this exercise are as follows:</p>
<ol>
<li><p>Sign in to the Azure Portal.</p>
</li>
<li><p>Create a container by using the Portal.</p>
</li>
<li><p>Add and access blob files in your container.</p>
</li>
</ol>
<h4 id="task-1-sign-in-to-the-azure-portal">Task 1: Sign in to the Azure Portal</h4>
<p>Sign in to the Azure Portal (<a href="https://portal.azure.com">https://portal.azure.com</a>).</p>
<h4 id="task-2-create-a-container-by-using-the-portal">Task 2: Create a container by using the Portal</h4>
<ol>
<li><p>View the list of Storage instances for your subscription.</p>
</li>
<li><p>Go to the <strong>Blob Service</strong> blade for your <strong>stor20532[<em>Your Name</em>]</strong> subscription.</p>
</li>
<li><p>Create a new Container with the following values:</p>
<ul>
<li><p>Name: <strong>example</strong></p>
</li>
<li><p>Access Type: <strong>Container</strong></p>
</li>
</ul>
</li>
<li><p>Record the <em>account name</em> for your Storage Account instance.</p>
</li>
<li><p>Select an access key and record the <em>connection string</em> for that key.</p>
</li>
</ol>
<h4 id="task-3-add-and-access-blob-files-in-your-container">Task 3: Add and access blob files in your container</h4>
<ol>
<li><p>Open Visual Studio 2017.</p>
</li>
<li><p>Open the <strong>Storage Accounts</strong> node in the <strong>Cloud Explorer</strong> pane.</p>
</li>
<li><p>Open the <strong>example</strong> container in your previously modified storage account:</p>
<ul>
<li><p>Account name: <strong>stor20532<em>[Your Name]</em></strong></p>
</li>
<li><p>Container name: <strong>example</strong></p>
</li>
</ul>
</li>
<li><p>In the <strong>Container</strong> tab, upload the sample file that is located at the following location:</p>
<ul>
<li>Sample File Location: <strong>(F):\Mod07\LabFiles\Starter\samplefile.txt</strong></li>
</ul>
</li>
<li><p>View the sample file’s text in Internet Explorer by using the following URL:</p>
<ul>
<li><a href="https://[account].blob.core.windows.net/example/samplefile.txt">https://[account].blob.core.windows.net/example/samplefile.txt</a></li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>Results:</strong> After completing this exercise, you will have created a blob container by using the Portal and viewed the blobs in the container.</p>
</blockquote>
<h2 id="exercise-2-populating-the-container-with-files-and-media">Exercise 2: Populating the Container with Files and Media</h2>
<h3 id="scenario">Scenario</h3>
<p>In this exercise, you will:</p>
<ul>
<li><p>Use the Azure Storage SDK to access blobs in your storage account.</p>
</li>
<li><p>Use the Azure Storage SDK to create blobs in your storage account.</p>
</li>
</ul>
<p>The main tasks for this exercise are as follows:</p>
<ol>
<li><p>Open the blob helper in the Web App worker project.</p>
</li>
<li><p>Add Word documents to the container after they are created.</p>
</li>
</ol>
<h4 id="task-1-open-the-blob-helper-in-the-web-app-worker-project">Task 1: Open the blob helper in the Web App worker project</h4>
<ol>
<li><p>Open the <strong>Contoso.Events</strong> solution from the following location:</p>
<ul>
<li>File location: <strong>Allfiles (F):\Mod07\Labfiles\Starter\Contoso.Events</strong></li>
</ul>
</li>
<li><p>Open the <strong>BlobStorageHelper.cs</strong> file in the <strong>Contoso.Events.Worker</strong> project.</p>
</li>
</ol>
<h4 id="task-2-add-word-documents-to-the-container-after-they-are-created">Task 2: Add Word documents to the container after they are created</h4>
<ol>
<li><p>Remove the existing code from the <strong>CreateBlob</strong> method.</p>
</li>
<li><p>Create a <em>CloudBlobContainer</em> variable for the <strong>signin</strong> container and ensure that the container exists by using the following code:</p>
<pre><code>CloudBlobContainer container = _blobClient.GetContainerReference(&quot;signin&quot;);

container.CreateIfNotExists();
</code></pre></li>
<li><p>Create a name for your blob by using the following format: <strong>“{eventKey}_SignIn_{date}”</strong>.</p>
</li>
<li><p>Create a blob reference by using the new <strong>blobName</strong> variable, use the Seek method on the <strong>MemoryStream</strong> to set the position back to the beginning (Origin), and then upload the stream to the blob by using the <strong>UploadFromStream</strong> method as shown in the following code:</p>
<pre><code>ICloudBlob blob = container.GetBlockBlobReference(blobName);

stream.Seek(0, SeekOrigin.Begin);

blob.UploadFromStream(stream);
</code></pre></li>
<li><p>Return the blob’s <strong>Uri</strong> property as the result of the method.</p>
</li>
</ol>
<blockquote>
<p><strong>Results:</strong> After completing this exercise, you will have used the Azure Storage SDK to manage blobs and containers in your storage account.</p>
</blockquote>
<h2 id="exercise-3-retrieving-files-and-media-from-the-container">Exercise 3: Retrieving Files and Media from the Container</h2>
<h3 id="scenario">Scenario</h3>
<p>In this exercise, you will:</p>
<ul>
<li>Retrieve blobs from your storage account by using the Azure Storage SDK.</li>
</ul>
<p>The main tasks for this exercise are as follows:</p>
<ol>
<li><p>Download documents from blob storage and stream to the client.</p>
</li>
<li><p>Generate the Test Data.</p>
</li>
<li><p>Download generated sign-in sheets from the blob storage.</p>
</li>
</ol>
<h4 id="task-1-download-documents-from-blob-storage-and-stream-to-the-client">Task 1: Download documents from blob storage and stream to the client</h4>
<ol>
<li><p>Open the <strong>DownloadViewModel.cs</strong> file in the <strong>Contoso.Events.ViewModels</strong> project.</p>
</li>
<li><p>Remove the existing code from the <strong>GetStream</strong> method.</p>
</li>
<li><p>Use the <em>_storageAccount</em> variable to create a new <strong>CloudBlobClient</strong> instance, create a <em>CloudBlobContainer</em> variable for the <strong>signin</strong> container, and then ensure that the container exists as shown in the following code:</p>
<pre><code>CloudBlobClient blobClient = _storageAccount.CreateCloudBlobClient();

CloudBlobContainer container = blobClient.GetContainerReference(&quot;signin&quot;);

container.CreateIfNotExists();
</code></pre></li>
<li><p>Create a blob reference by using the new <strong>_blobId</strong> variable, and then use the <strong>OpenReadAsync</strong> method to create a <em>Stream</em> variable as shown in the following code:</p>
<pre><code>ICloudBlob blob = container.GetBlockBlobReference(_blobId);

Stream blobStream = await blob.OpenReadAsync();
</code></pre></li>
<li><p>Return a new instance of the <strong>DownloadPayload</strong> class by assigning the <em>Stream</em> variable to the <strong>DownloadPayload.Stream</strong> property and assign the <em>ICloudBlob</em> variable’s <strong>Properties.ContentType</strong> value to the <strong>DownloadPayload.ContentType</strong> property.</p>
</li>
</ol>
<h4 id="task-2-generate-the-test-data">Task 2: Generate the Test Data</h4>
<ol>
<li><p>Locate the <strong>Contoso.Events.Data.Generation</strong> project.</p>
</li>
<li><p>Update the <strong>app.config</strong> file in the project to use your <em>Storage Account</em>&#39;s connection string in the <strong>StorageConnectionString</strong> <em>AppSetting</em>.</p>
</li>
<li><p>Debug the <strong>Contoso.Events.Data.Generation</strong> project to generate the SQL and storage tables data.</p>
</li>
</ol>
<h4 id="task-3-download-generated-sign-in-sheets-from-the-blob-storage">Task 3: Download generated sign-in sheets from the blob storage</h4>
<ol>
<li><p>Update your solution configuration to start both the <strong>Contoso.Events.Web</strong>, <strong>Contoso.Events.Worker</strong> and <strong>Contoso.Events.Management</strong> projects when the solution is debugged.</p>
</li>
<li><p>Update the <strong>web.config</strong> file in the <strong>Contoso.Events.Web</strong> project to use your <em>Storage Account</em>&#39;s connection string in the <strong>Microsoft.WindowsAzure.Storage.ConnectionString</strong> <em>AppSetting</em>.</p>
</li>
<li><p>Update the <strong>web.config</strong> file in the <strong>Contoso.Events.Management</strong> project to use your <em>Storage Account</em>&#39;s connection string in the <strong>Microsoft.WindowsAzure.Storage.ConnectionString</strong> <em>AppSetting</em>.</p>
</li>
<li><p>Update the <strong>app.config</strong> file in the <strong>Contoso.Events.Worker</strong> project to use your <em>Storage Account</em>&#39;s connection string in the following locations:</p>
<ul>
<li><p><strong>StorageConnectionString</strong> <em>AppSetting</em></p>
</li>
<li><p><strong>AzureWebJobsStorage</strong> <em>ConnectionString</em></p>
</li>
<li><p><strong>AzureWebJobsDashboard</strong> <em>ConnectionString</em></p>
</li>
</ul>
</li>
<li><p>Debug the <strong>Contoso.Events.Web</strong>, <strong>Contoso.Events.Worker</strong> and <strong>Contoso.Events.Management</strong> projects.</p>
</li>
<li><p>In the <strong>Contoso Events Administration</strong> web application, select any event, generate a sign-in sheet, and then download the sign-in sheet.</p>
<blockquote>
<p><strong>Note:</strong> Currently, the web application gets a Stream of the blob and uses MVC’s file helper to return the file to the user. The implementation is available to view in the <strong>DownloadSignIn</strong> method of the <strong>HomeController</strong> class in the <strong>Contoso.Events.Management</strong> project.<strong> </strong></p>
</blockquote>
</li>
</ol>
<blockquote>
<p><strong>Results:</strong> After completing this exercise, you will have downloaded blobs from your storage account by using the Azure Storage SDK.</p>
</blockquote>
<h2 id="exercise-4-specifying-permissions-for-the-container">Exercise 4: Specifying Permissions for the Container</h2>
<h3 id="scenario">Scenario</h3>
<p>In this exercise, you will:</p>
<ul>
<li><p>Use the Visual Studio 2017 Cloud Explorer to modify a container.</p>
</li>
<li><p>Generate a SAS token by using the Azure Storage SDK.</p>
</li>
</ul>
<p>The main tasks for this exercise are as follows:</p>
<ol>
<li><p>Modify Container Access using Cloud Explorer.</p>
</li>
<li><p>Generate temporary SAS tokens by using the SDK.</p>
</li>
<li><p>Download documents from a protected container by using the SAS token.</p>
</li>
</ol>
<h4 id="task-1-modify-container-access-using-cloud-explorer">Task 1: Modify Container Access using Cloud Explorer</h4>
<ol>
<li><p>Switch to the <em>Contoso.Events - Visual Studio 2017</em> window, and then stop debugging.</p>
</li>
<li><p>Open the <strong>Storage Accounts</strong> node of the <strong>Cloud Explorer</strong> pane.</p>
</li>
<li><p>View the <strong>signin</strong> container in your recently used storage account:</p>
<ul>
<li><p>Account name: <strong>stor20532[<em>Your Name</em>]</strong></p>
</li>
<li><p>Container name: <strong>signin</strong></p>
</li>
</ul>
</li>
<li><p>Change the <strong>signin</strong> container’s public access to <strong>Off</strong>.</p>
</li>
</ol>
<h4 id="task-2-generate-temporary-sas-tokens-by-using-the-sdk">Task 2: Generate temporary SAS tokens by using the SDK</h4>
<ol>
<li><p>Open the <strong>DownloadViewModel.cs</strong> file in the <strong>Contoso.Events.ViewModels</strong> project.</p>
</li>
<li><p>Remove the existing code from the <strong>GetSecureUrl</strong> method.</p>
</li>
<li><p>Use the <em>_storageAccount</em> variable to create a new <strong>CloudBlobClient</strong>, create a <em>CloudBlobContainer</em> variable for the <strong>signin</strong> container, and then ensure that the container exists as shown in the following code:</p>
<pre><code>CloudBlobClient blobClient = _storageAccount.CreateCloudBlobClient();

CloudBlobContainer container = blobClient.GetContainerReference(&quot;signin&quot;);

container.CreateIfNotExists();
</code></pre></li>
<li><p>Create a new instance of the <strong>SharedAccessBlobPolicy</strong> class, set the expiry time to 15 minutes from the current time, and then set the blob permission to read as shown in the following code:</p>
<pre><code>SharedAccessBlobPolicy blobPolicy = new SharedAccessBlobPolicy();

blobPolicy.SharedAccessExpiryTime = DateTime.Now.AddHours(0.25d);

blobPolicy.Permissions = SharedAccessBlobPermissions.Read;
</code></pre></li>
<li><p>Create a new instance of the <strong>BlobContainerPermissions</strong> class, add the newly created <strong>SharedAccessBlobPolicy</strong> with the name <strong>“ReadBlobPolicy”</strong>, and then disable public access as shown in the following code:</p>
<pre><code>BlobContainerPermissions blobPermissions = new BlobContainerPermissions();

blobPermissions.SharedAccessPolicies.Add(&quot;ReadBlobPolicy&quot;, blobPolicy);

blobPermissions.PublicAccess = BlobContainerPublicAccessType.Off;
</code></pre></li>
<li><p>Use the <strong>CloudBlobContainer</strong> asynchronous <strong>SetPermissionsAsync</strong> method to apply the <em>BlobContainerPermissions</em> variable, and then generate a SAS token by using the <strong>GetSharedAccessSignature</strong> method as shown in the following code:</p>
<pre><code>await container.SetPermissionsAsync(blobPermissions);

string sasToken = container.GetSharedAccessSignature(new SharedAccessBlobPolicy(), &quot;ReadBlobPolicy&quot;);
</code></pre></li>
<li><p>Create a blob reference by using the <em>_blobId</em> variable, and then store the Blob’s Uri in a <em>Uri</em> variable as shown in the following code:</p>
<pre><code>ICloudBlob blob = container.GetBlockBlobReference(_blobId);

Uri blobUrl = blob.Uri;
</code></pre></li>
<li><p>Concatenate the <em>Uri</em> variable’s <strong>AbsoluteUri</strong> property with the <strong>sasToken</strong>, and then return the new string as the result of the method.</p>
</li>
</ol>
<h4 id="task-3-download-documents-from-a-protected-container-by-using-the-sas-token">Task 3: Download documents from a protected container by using the SAS token</h4>
<ol>
<li><p>Debug the solution again.</p>
</li>
<li><p>In the <strong>Contoso Events Administration</strong> web application, select any event, generate a sign-in sheet, and then download the sign-in sheet using the hyperlink instead.</p>
<blockquote>
<p><strong>Note:</strong> You can always look at Internet Explorer’s download manager if you want to see the full URL that is used (with SAS Token) to download the file.</p>
</blockquote>
</li>
<li><p>Close the <strong>Internet Explorer</strong> and <strong>Contoso.Events – Visual Studio</strong> windows.</p>
</li>
</ol>
<blockquote>
<p><strong>Results:</strong> After completing this exercise, you will have modified the permissions of the containers and generated SAS tokens for the containers.</p>
</blockquote>
<p>©2016 Microsoft Corporation. All rights reserved. The text in this document is available under the <a href="https://creativecommons.org/licenses/by/3.0/legalcode">Creative Commons Attribution 3.0 License</a>, additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are <strong><em>not</em></strong> included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.</p>
<p>This document is provided &quot;as-is.&quot; Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.</p>
